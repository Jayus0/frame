# 服务降级方案使用说明

## 概述

服务降级方案是容错机制的重要组成部分，当服务出现故障时，系统可以自动切换到备用方案，保证核心功能的可用性。降级方案与熔断器、重试策略配合，形成完整的容错链路。

## 功能特性

- ✅ **多种触发条件**：熔断器开启、超时、错误率过高、手动触发
- ✅ **多种降级策略**：备用服务、默认值、简化服务、禁用服务
- ✅ **自动降级**：与熔断器和重试策略自动集成
- ✅ **灵活配置**：为每个服务单独配置降级策略
- ✅ **降级恢复**：服务恢复后自动切换回正常服务

## 降级触发条件

### 1. 熔断器开启（CircuitBreakerOpen）
当服务的熔断器处于Open状态时触发降级。

**适用场景：**
- 服务连续失败，熔断器已开启
- 需要快速切换到备用方案

### 2. 超时（Timeout）
当服务调用超时时触发降级。

**适用场景：**
- 服务响应缓慢
- 网络延迟过高

### 3. 错误率过高（ErrorRate）
当服务的错误率超过阈值时触发降级。

**适用场景：**
- 服务部分功能异常
- 需要根据错误率动态降级

### 4. 手动触发（Manual）
由外部手动触发降级。

**适用场景：**
- 计划内维护
- 主动降级测试

### 5. 总是降级（Always）
总是使用降级方案（用于测试）。

## 降级策略类型

### 1. 备用服务（FallbackService）
使用备用服务替代原服务。

**示例：**
```cpp
DegradationPolicyConfig config;
config.serviceName = "UserService";
config.trigger = DegradationTrigger::CircuitBreakerOpen;
config.strategy = DegradationStrategy::FallbackService;
config.fallbackServiceName = "UserServiceBackup";
config.fallbackMethod = "getUser";  // 可选，默认使用原方法名

serviceRegistry->setDegradationPolicy("UserService", config);
```

### 2. 默认值（DefaultValue）
返回预定义的默认值。

**示例：**
```cpp
DegradationPolicyConfig config;
config.serviceName = "ConfigService";
config.trigger = DegradationTrigger::Timeout;
config.strategy = DegradationStrategy::DefaultValue;
config.defaultValue = QVariant("{}");  // 返回空JSON对象

serviceRegistry->setDegradationPolicy("ConfigService", config);
```

### 3. 简化服务（SimplifiedService）
使用功能简化的服务版本。

**示例：**
```cpp
DegradationPolicyConfig config;
config.serviceName = "SearchService";
config.trigger = DegradationTrigger::ErrorRate;
config.strategy = DegradationStrategy::SimplifiedService;
config.simplifiedServiceName = "SearchServiceSimple";
config.errorRateThreshold = 0.5;  // 错误率超过50%时降级

serviceRegistry->setDegradationPolicy("SearchService", config);
```

### 4. 禁用服务（Disabled）
禁用服务，返回空值。

**示例：**
```cpp
DegradationPolicyConfig config;
config.serviceName = "NonEssentialService";
config.trigger = DegradationTrigger::CircuitBreakerOpen;
config.strategy = DegradationStrategy::Disabled;

serviceRegistry->setDegradationPolicy("NonEssentialService", config);
```

## 使用方法

### 基本使用

```cpp
#include "eagle/core/Framework.h"
#include "eagle/core/ServiceRegistry.h"
#include "eagle/core/DegradationPolicy.h"

using namespace Eagle::Core;

// 获取框架实例
Framework* framework = Framework::instance();
framework->initialize();

// 获取服务注册表
ServiceRegistry* serviceRegistry = framework->serviceRegistry();

// 配置降级策略
DegradationPolicyConfig config;
config.serviceName = "UserService";
config.trigger = DegradationTrigger::CircuitBreakerOpen;
config.strategy = DegradationStrategy::FallbackService;
config.fallbackServiceName = "UserServiceBackup";

serviceRegistry->setDegradationPolicy("UserService", config);

// 调用服务（自动应用降级策略）
QVariantList args;
args << "user123";
QVariant result = serviceRegistry->callService("UserService", "getUser", args);

if (result.isValid()) {
    qDebug() << "调用成功:" << result;
} else {
    qDebug() << "调用失败（已尝试降级）";
}
```

### 配置多个降级策略

可以为同一个服务配置多个降级策略，系统会按优先级选择：

```cpp
// 主降级策略：熔断器开启时使用备用服务
DegradationPolicyConfig primaryConfig;
primaryConfig.serviceName = "UserService";
primaryConfig.trigger = DegradationTrigger::CircuitBreakerOpen;
primaryConfig.strategy = DegradationStrategy::FallbackService;
primaryConfig.fallbackServiceName = "UserServiceBackup";
serviceRegistry->setDegradationPolicy("UserService", primaryConfig);

// 备用降级策略：超时时返回默认值
DegradationPolicyConfig fallbackConfig;
fallbackConfig.serviceName = "UserService";
fallbackConfig.trigger = DegradationTrigger::Timeout;
fallbackConfig.strategy = DegradationStrategy::DefaultValue;
fallbackConfig.defaultValue = QVariant("{\"id\":\"\",\"name\":\"Unknown\"}");
// 注意：同一服务只能有一个策略，需要合并配置
```

### 启用/禁用降级

```cpp
// 全局启用/禁用降级
serviceRegistry->setDegradationEnabled(true);
bool enabled = serviceRegistry->isDegradationEnabled();

// 为特定服务启用/禁用降级
DegradationPolicyConfig config = serviceRegistry->getDegradationPolicy("UserService");
config.enabled = false;
serviceRegistry->setDegradationPolicy("UserService", config);
```

## 配置示例

### 示例1：高可用服务（备用服务）

适用于关键业务服务：

```cpp
DegradationPolicyConfig config;
config.serviceName = "PaymentService";
config.trigger = DegradationTrigger::CircuitBreakerOpen;
config.strategy = DegradationStrategy::FallbackService;
config.fallbackServiceName = "PaymentServiceBackup";
config.fallbackMethod = "processPayment";

serviceRegistry->setDegradationPolicy("PaymentService", config);
```

### 示例2：非关键服务（默认值）

适用于非关键业务服务：

```cpp
DegradationPolicyConfig config;
config.serviceName = "RecommendationService";
config.trigger = DegradationTrigger::Timeout;
config.strategy = DegradationStrategy::DefaultValue;
config.defaultValue = QVariant("[]");  // 返回空列表

serviceRegistry->setDegradationPolicy("RecommendationService", config);
```

### 示例3：复杂服务（简化服务）

适用于功能复杂的服务：

```cpp
DegradationPolicyConfig config;
config.serviceName = "SearchService";
config.trigger = DegradationTrigger::ErrorRate;
config.strategy = DegradationStrategy::SimplifiedService;
config.simplifiedServiceName = "SearchServiceSimple";
config.errorRateThreshold = 0.3;  // 错误率超过30%时降级
config.errorRateWindowMs = 60000;  // 统计窗口60秒

serviceRegistry->setDegradationPolicy("SearchService", config);
```

### 示例4：可降级服务（禁用）

适用于可以暂时禁用的服务：

```cpp
DegradationPolicyConfig config;
config.serviceName = "AnalyticsService";
config.trigger = DegradationTrigger::CircuitBreakerOpen;
config.strategy = DegradationStrategy::Disabled;

serviceRegistry->setDegradationPolicy("AnalyticsService", config);
```

## 与熔断器和重试策略的配合

降级方案与熔断器、重试策略形成完整的容错链路：

1. **正常调用**：直接调用服务
2. **失败重试**：如果失败，根据重试策略进行重试
3. **熔断保护**：如果连续失败，熔断器开启
4. **降级切换**：熔断器开启后，自动切换到降级方案
5. **恢复检测**：服务恢复后，自动切换回正常服务

**执行流程：**
```
服务调用
  ↓
检查熔断器
  ↓ (开启)
尝试重试
  ↓ (失败)
触发降级
  ↓
执行降级策略
  ↓
返回结果
```

## 错误处理

### 降级失败

如果降级策略也失败，系统会：
1. 记录降级失败日志
2. 返回空值（QVariant()）
3. 触发 `serviceCallFailed` 信号

### 避免无限递归

系统会自动检测并避免降级服务的无限递归：
- 如果备用服务与原服务同名，不会递归调用
- 如果简化服务与原服务同名，不会递归调用

## 日志输出

降级过程中会输出详细的日志：

```
[INFO] ServiceRegistry: 降级到备用服务: UserServiceBackup::getUser
[INFO] ServiceRegistry: 服务降级成功: UserService::getUser
```

## 性能考虑

1. **降级延迟**：降级切换会有少量延迟（通常<10ms）
2. **备用服务性能**：确保备用服务有足够的性能
3. **默认值大小**：默认值应该尽量小，避免内存占用

## 最佳实践

1. **关键服务**：使用备用服务降级，保证高可用
2. **非关键服务**：使用默认值降级，快速返回
3. **复杂服务**：使用简化服务降级，保留核心功能
4. **可降级服务**：使用禁用策略，暂时关闭服务
5. **测试验证**：定期测试降级策略，确保正常工作

## 注意事项

1. **备用服务可用性**：确保备用服务本身是可靠的
2. **数据一致性**：降级服务可能返回的数据格式不同
3. **性能影响**：降级服务可能性能较低
4. **监控告警**：降级触发时应该发送告警通知

## 配置参数说明

| 参数 | 类型 | 说明 | 默认值 |
|------|------|------|--------|
| serviceName | QString | 服务名称 | 必填 |
| trigger | DegradationTrigger | 触发条件 | CircuitBreakerOpen |
| strategy | DegradationStrategy | 降级策略 | DefaultValue |
| fallbackServiceName | QString | 备用服务名称 | 空 |
| fallbackMethod | QString | 备用方法名称 | 空（使用原方法） |
| defaultValue | QVariant | 默认值 | 空 |
| simplifiedServiceName | QString | 简化服务名称 | 空 |
| errorRateThreshold | double | 错误率阈值 | 0.5 |
| errorRateWindowMs | int | 错误率统计窗口 | 60000 |
| enabled | bool | 是否启用 | true |

## 示例代码

完整示例：

```cpp
#include "eagle/core/Framework.h"
#include "eagle/core/ServiceRegistry.h"

int main(int argc, char *argv[])
{
    QCoreApplication app(argc, argv);
    
    // 初始化框架
    Framework* framework = Framework::instance();
    framework->initialize();
    
    ServiceRegistry* registry = framework->serviceRegistry();
    
    // 配置降级策略
    DegradationPolicyConfig config;
    config.serviceName = "UserService";
    config.trigger = DegradationTrigger::CircuitBreakerOpen;
    config.strategy = DegradationStrategy::FallbackService;
    config.fallbackServiceName = "UserServiceBackup";
    config.fallbackMethod = "getUser";
    
    registry->setDegradationPolicy("UserService", config);
    
    // 调用服务（自动应用降级策略）
    QVariantList args;
    args << "user123";
    QVariant result = registry->callService("UserService", "getUser", args);
    
    if (result.isValid()) {
        qDebug() << "调用成功:" << result;
    } else {
        qDebug() << "调用失败（已尝试降级）";
    }
    
    return 0;
}
```

## 与重试策略的配合

降级策略在重试失败后触发：

```cpp
// 配置重试策略
RetryPolicyConfig retryConfig;
retryConfig.maxRetries = 3;
retryConfig.strategy = RetryStrategy::Exponential;
registry->setRetryPolicy("UserService", retryConfig);

// 配置降级策略
DegradationPolicyConfig degradeConfig;
degradeConfig.trigger = DegradationTrigger::ErrorRate;
degradeConfig.strategy = DegradationStrategy::DefaultValue;
degradeConfig.defaultValue = QVariant("{}");
registry->setDegradationPolicy("UserService", degradeConfig);

// 执行流程：
// 1. 尝试调用服务
// 2. 失败后重试（最多3次）
// 3. 重试失败后触发降级
// 4. 返回默认值
```
